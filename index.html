<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Thrones of Honor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0;
      font-family: Georgia, serif;
      background: #000;
      color: gold;
      text-align: center;
    }
    #hud {
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      position: fixed;
      top: 0;
      width: 100%;
      font-size: 16px;
      z-index: 1000;
    }
    h2 { margin-top: 60px; }
    button, input {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
    }
    input {
      width: 60%;
    }
    #missionBox, #shopBox, #inventoryBox, #giftBox, #leaderboardBox {
      margin-top: 20px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    canvas {
      margin-top: 30px;
      border: 2px solid gold;
      background: #111;
    }
  </style>
</head>
<body>

  <div id="hud">Loading...</div>

  <div id="missionBox">
    <h2>üî• North Watch Missions</h2>
    <button onclick="completeMission('Scout Ice Trail', 30)">Scout Ice Trail</button>
    <button onclick="completeMission('Slay Ice Beast', 60)">Slay Ice Beast</button>
  </div>

  <div id="shopBox">
    <h2>üõí Shop</h2>
    <button onclick="buyItem('Sword of Valor', 50)">Buy Sword (50 Gold)</button>
    <button onclick="buyItem('Shield of Flame', 60)">Buy Shield (60 Gold)</button>
    <button onclick="buyItem('Crown', 100)">Buy Crown (100 Gold)</button>
    <button onclick="buyItem('Dragon', 350)">Unlock Dragon (350 Gold or Level 5)</button>
    <button onclick="buyFire(10)">Buy 10 Fire (10 Gold)</button>
  </div>

  <div id="inventoryBox">
    <h2>üéí Inventory</h2>
    <ul id="inventoryList">Loading...</ul>
  </div>

  <div id="giftBox">
    <h2>üéÅ Redeem Gift Code</h2>
    <input type="text" id="giftCodeInput" placeholder="Enter gift code">
    <button onclick="redeemGiftCode()">Redeem</button>
    <p id="giftMessage"></p>
  </div>

  <div id="leaderboardBox">
    <h2>üèÜ Leaderboard</h2>
    <ol id="leaderList">Loading...</ol>
  </div>

  <canvas id="gameMap" width="300" height="300"></canvas> <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion
} from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";
import {
  getAuth, signInAnonymously, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCrMnWwR3vTRSQMoid6j0d5NiO2jDdykgc",
  authDomain: "thrones-of-honor.firebaseapp.com",
  projectId: "thrones-of-honor",
  storageBucket: "thrones-of-honor.firebasestorage.app",
  messagingSenderId: "124769370805",
  appId: "1:124769370805:web:1f2c5a7102ad868cf834fc"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

let uid = null;
let player = { username: "Hero", gold: 0, level: 1, fire: 0, inventory: [] };

signInAnonymously(auth);
onAuthStateChanged(auth, async user => {
  if (user) {
    uid = user.uid;
    const userRef = doc(db, "users", uid);
    const userSnap = await getDoc(userRef);
    if (!userSnap.exists()) {
      await setDoc(userRef, player);
    } else {
      player = userSnap.data();
    }
    updateHUD();
    loadInventory();
    loadLeaderboard();
  }
});

function updateHUD() {
  document.getElementById("hud").innerText =
    `üë§ ${player.username} | üèÜ Level ${player.level} | üí∞ ${player.gold} Gold | üî• Fire: ${player.fire}`;
}

async function completeMission(title, effort) {
  const rewardGold = effort >= 50 ? 13 : 5;
  player.gold += rewardGold;
  player.level += 1;
  await updateDoc(doc(db, "users", uid), {
    gold: player.gold,
    level: player.level
  });
  alert(`‚úÖ Completed: ${title}\n+${rewardGold} gold`);
  updateHUD();
  loadLeaderboard();
}

async function buyItem(itemName, cost) {
  if (itemName === "Dragon") {
    if (player.inventory.includes("Dragon")) {
      return alert("üêâ Dragon already unlocked.");
    }
    if (player.level >= 5 || player.gold >= cost) {
      if (player.gold >= cost) player.gold -= cost;
      player.inventory.push("Dragon");
      player.fire = 10;
      await updateDoc(doc(db, "users", uid), {
        gold: player.gold,
        inventory: arrayUnion("Dragon"),
        fire: player.fire
      });
      updateHUD();
      loadInventory();
      return alert("üêâ Dragon unlocked! You now have 10 fire.");
    } else {
      return alert("‚ùå Reach level 5 or have 350 gold to unlock dragon.");
    }
  }

  if (player.gold < cost) return alert("‚ùå Not enough gold.");
  player.gold -= cost;
  player.inventory.push(itemName);
  await updateDoc(doc(db, "users", uid), {
    gold: player.gold,
    inventory: arrayUnion(itemName)
  });
  alert(`‚úÖ Bought ${itemName}`);
  updateHUD();
  loadInventory();
}

async function buyFire(amount = 10) {
  const cost = 10;
  if (player.gold < cost) return alert("‚ùå Not enough gold.");
  player.gold -= cost;
  player.fire += amount;
  await updateDoc(doc(db, "users", uid), {
    gold: player.gold,
    fire: player.fire
  });
  alert(`üî• Bought ${amount} fire`);
  updateHUD();
}

async function loadInventory() {
  const ref = doc(db, "users", uid);
  const snap = await getDoc(ref);
  const list = document.getElementById("inventoryList");
  list.innerHTML = "";
  if (snap.exists()) {
    (snap.data().inventory || []).forEach(item => {
      const li = document.createElement("li");
      li.innerText = item;
      list.appendChild(li);
    });
  }
}

async function redeemGiftCode() {
  const code = document.getElementById("giftCodeInput").value.trim().toUpperCase();
  if (!code) return;

  const giftRef = doc(db, "giftcodes", code);
  const snap = await getDoc(giftRef);
  const msg = document.getElementById("giftMessage");

  if (!snap.exists()) return msg.innerText = "‚ùå Invalid code.";
  const used = snap.data().usedBy || [];
  if (used.includes(uid)) return msg.innerText = "‚ùå Already redeemed.";

  const bonus = snap.data().gold || 20;
  player.gold += bonus;
  await updateDoc(doc(db, "users", uid), { gold: player.gold });
  await updateDoc(giftRef, { usedBy: arrayUnion(uid) });
  msg.innerText = `‚úÖ +${bonus} gold!`;
  updateHUD();
}

async function loadLeaderboard() {
  const userSnap = await getDoc(doc(db, "users", uid));
  const ref = doc(db, "leaderboard", "top");
  let top = [];

  if (userSnap.exists()) {
    const userEntry = {
      username: userSnap.data().username || "Hero",
      gold: userSnap.data().gold || 0,
      level: userSnap.data().level || 1
    };
    const snap = await getDoc(ref);
    if (snap.exists()) {
      top = snap.data().users || [];
      top.push(userEntry);
      top = top.sort((a, b) => b.gold - a.gold).slice(0, 5);
    } else {
      top = [userEntry];
    }
    await setDoc(ref, { users: top });
  }

  const list = document.getElementById("leaderList");
  list.innerHTML = "";
  top.forEach(u => {
    const li = document.createElement("li");
    li.innerText = `${u.username} - ${u.gold}G - Level ${u.level}`;
    list.appendChild(li);
  });
}

// canvas movement
const canvas = document.getElementById("gameMap");
const ctx = canvas.getContext("2d");
let x = 150, y = 150;

function drawMap() {
  ctx.fillStyle = "#222";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "#0055aa"; ctx.fillRect(200, 200, 60, 60); // ocean
  ctx.fillStyle = "#555"; ctx.fillRect(50, 50, 40, 40); // mountain
  ctx.fillStyle = "gold"; ctx.beginPath(); ctx.arc(x, y, 10, 0, Math.PI * 2); ctx.fill();
}
function movePlayer(dx, dy) { x += dx; y += dy; drawMap(); }
window.addEventListener("keydown", e => {
  if (e.key === "ArrowUp") movePlayer(0, -10);
  else if (e.key === "ArrowDown") movePlayer(0, 10);
  else if (e.key === "ArrowLeft") movePlayer(-10, 0);
  else if (e.key === "ArrowRight") movePlayer(10, 0);
});
drawMap();
</script>
</body>
</html>
